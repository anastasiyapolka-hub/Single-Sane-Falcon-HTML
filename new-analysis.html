<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Work area</title>
    <link rel="icon" type="image/png" href="images/cotel-cat.png">
    <meta property="og:title" content="New-Analysis - Single Sane Falcon" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8" />
    <meta property="twitter:card" content="summary_large_image" />

    <style data-tag="reset-style-sheet">
      html {  line-height: 1.15;}body {  margin: 0;}* {  box-sizing: border-box;  border-width: 0;  border-style: solid;  -webkit-font-smoothing: antialiased;}p,li,ul,pre,div,h1,h2,h3,h4,h5,h6,figure,blockquote,figcaption {  margin: 0;  padding: 0;}button {  background-color: transparent;}button,input,optgroup,select,textarea {  font-family: inherit;  font-size: 100%;  line-height: 1.15;  margin: 0;}button,select {  text-transform: none;}button,[type="button"],[type="reset"],[type="submit"] {  -webkit-appearance: button;  color: inherit;}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner {  border-style: none;  padding: 0;}button:-moz-focus,[type="button"]:-moz-focus,[type="reset"]:-moz-focus,[type="submit"]:-moz-focus {  outline: 1px dotted ButtonText;}a {  color: inherit;  text-decoration: inherit;}pre {  white-space: normal;}input {  padding: 2px 4px;}img {  display: block;}details {  display: block;  margin: 0;  padding: 0;}summary::-webkit-details-marker {  display: none;}[data-thq="accordion"] [data-thq="accordion-content"] {  max-height: 0;  overflow: hidden;  transition: max-height 0.3s ease-in-out;  padding: 0;}[data-thq="accordion"] details[data-thq="accordion-trigger"][open] + [data-thq="accordion-content"] {  max-height: 1000vh;}details[data-thq="accordion-trigger"][open] summary [data-thq="accordion-icon"] {  transform: rotate(180deg);}html { scroll-behavior: smooth  }
    </style>
    <style data-tag="default-style-sheet">
      html {
        font-family: "Noto Sans";
        font-size: 1rem;
      }

    
      body {
        font-weight: 400;
        font-style:normal;
        text-decoration: undefined;
        text-transform: undefined;
        letter-spacing: 0.01em;
        line-height: 1.6;
        color: var(--color-on-surface);
        background: var(--color-surface);

        fill: var(--color-on-surface);
      }
    </style>

      <style>
      /* Лейаут: слева сайдбар, справа рабочая область */
      .dashboard-layout {
        display: flex;
        align-items:  flex-start;
      }

      /* Левая колонка */
      .dashboard-sidebar {
        width: 300px;
        padding: 16px 20px;
        border-right: 1px solid rgba(0, 0, 0, 0.06);
        /* background: #f9fafb;*/
        background: #f3f4f6; /* мягкий светло-серый */
        font-size: 0.9rem;
      }

      .dashboard-sidebar h3 {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .sidebar-section {
        margin-bottom: 18px;
      }

      .sidebar-section details {
        border-radius: 8px;
        padding: 8px 10px;
        background: #ffffff;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.04);
      }

      .sidebar-section summary {
        list-style: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: 600;
      }

      .sidebar-section summary::-webkit-details-marker {
        display: none;
      }

      .sidebar-section-body {
        margin-top: 8px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .sidebar-radio-row {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .sidebar-radio-row input[type="radio"] {
        margin: 0;
      }

        .tg-auth-block {
        margin: 6px 0 10px 22px;      /* чуть сдвигаем вправо + нижний отступ */
        padding: 12px 14px;
        border-radius: 12px;
        background: #fdfcf8;          /* молочно-белый */
        border: 1px solid #e5e7eb;    /* тонкая серая рамка */
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.04);
      }

      .tg-field {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-bottom: 10px;
        padding: 6px 8px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.7); /* лёгкая плашка под полями */
      }


      .tg-input {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid #d1d5db;
        font-size: 0.9rem;
      }

      .tg-button {
        margin-top: 4px;
        padding: 6px 14px;
        border-radius: 999px;
        border: 1px solid #d1d5db;
        background: #f3f4f6;
        cursor: pointer;
        font-size: 0.85rem;
      }

      .tg-button:hover {
        background: #e5e7eb;
      }

      .tg-status {
        font-size: 0.8rem;
        color: #6b7280;
        margin-top: 4px;
      }

      .dashboard-container {
        flex: 1;
      }

      @media (max-width: 900px) {
        .dashboard-layout {
          flex-direction: column;
        }

        .dashboard-sidebar {
          width: 100%;
          border-right: none;
          border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }
      }
    </style>

    <link
      rel="stylesheet"
      href="https://unpkg.com/animate.css@4.1.1/animate.css"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap"
      data-tag="font"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap"
      data-tag="font"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=STIX+Two+Text:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&amp;display=swap"
      data-tag="font"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap"
      data-tag="font"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/@teleporthq/teleport-custom-scripts/dist/style.css"
    />
  </head>
  <body>
    <link rel="stylesheet" href="./style.css" />
      <link href="./new-analysis.css" rel="stylesheet" />

      <div class="new-analysis-container1">
        <navigation-wrapper class="navigation-wrapper">
          <!--Navigation component-->
          <div class="navigation-container1">
            <div class="navigation-container2">
              <div class="navigation-container3">
                <style>
                  @media (prefers-reduced-motion: reduce) {
                  .navigation__link::after, .navigation__logo::before, .navigation__overlay-link::before {
                    transition: none;
                  }
                  .navigation__overlay-link {
                    animation: none;
                  }
                  .navigation__logo:hover .navigation__logo-icon {
                    transform: none;
                  }
                  }
                </style>
              </div>
            </div>
            <nav id="mainNav" class="navigation">
              <div class="navigation__container">
                <div class="navigation__left">
                  <a href="#">
                    <div class="navigation__link">
                      <span>Новый анализ</span>
                    </div>
                  </a>
                  <a href="#">
                    <div class="navigation__link"><span>История</span></div>
                  </a>
                </div>
                <a href="#">
                  <div class="navigation__logo">
                   
                    <span class="section-title navigation__logo-text">
  CO
  <img
    src="images/cotel-cat.png"
    alt="CoTel logo"
    class="navigation-logo-cat"
  />
  TEL
</span>
                  </div>
                </a>
                <div class="navigation__right">
                  <a href="#">
                    <div class="navigation__link"><span>Настройки</span></div>
                  </a>
                  <a href="#">
                    <div class="navigation__link navigation__link--cta">
                      <span>Попробовать</span>
                    </div>
                  </a>
                </div>
                <button
                  id="navToggle"
                  aria-label="Открыть меню"
                  aria-expanded="false"
                  class="navigation__toggle"
                >
                  <svg
                    width="24"
                    xmlns="http://www.w3.org/2000/svg"
                    height="24"
                    viewBox="0 0 24 24"
                  >
                    <path
                      d="M4 5h16M4 12h16M4 19h16"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    ></path>
                  </svg>
                </button>
              </div>
            </nav>
            <div id="navOverlay" class="navigation__overlay">
              <div class="navigation__overlay-header">
                <a href="#">
                  <div class="navigation__overlay-logo">
                    
                    <span class="section-title">COTEL</span>
                  </div>
                </a>
                <button
                  id="navClose"
                  aria-label="Закрыть меню"
                  class="navigation__overlay-close"
                >
                  <svg
                    width="28"
                    xmlns="http://www.w3.org/2000/svg"
                    height="28"
                    viewBox="0 0 24 24"
                  >
                    <path
                      d="m18 6l-12 12M6 6l12 12"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    ></path>
                  </svg>
                </button>
              </div>
              <div class="navigation__overlay-content">
                <a href="#">
                  <div class="navigation__overlay-link">
                    <span>Новый анализ</span>
                  </div>
                </a>
                <a href="#">
                  <div class="navigation__overlay-link">
                    <span>История</span>
                  </div>
                </a>
                <a href="#">
                  <div class="navigation__overlay-link">
                    <span>Настройки</span>
                  </div>
                </a>
                <a href="#">
                  <div
                    class="navigation__overlay-link--cta navigation__overlay-link"
                  >
                    <span>Попробовать</span>
                  </div>
                </a>
              </div>
            </div>
            <div class="navigation-container4">
              <div class="navigation-container5">
                <style>
                          @keyframes slideIn {from {opacity: 0;
                  transform: translateY(-20px);}
                  to {opacity: 1;
                  transform: translateY(0);}}
                </style>
              </div>
            </div>
          
          </div>
        </navigation-wrapper>
        
        <div class="dashboard-main">

          <div class="dashboard-layout">
            <!-- ЛЕВАЯ КОЛОНКА: источник данных + авторизация --> 
           <aside class="dashboard-sidebar">

            <div class="sidebar-header">
            <button
              id="sidebarToggle"
              class="sidebar-toggle-btn"
              type="button"
              title="Свернуть панель"
            >
              ⚙️
            </button>
            <span class="sidebar-title">Настройки</span>
          </div>

             <!-- Весь остальной контент панели -->
              <div id="sidebarContent">
              <div class="sidebar-section">
                <details id="dataSourceSection" open>
                  <summary>
                    <span>Источник данных</span>
                    <span>▾</span>
                  </summary>

                  <div class="sidebar-section-body">
                    <!-- 1. Файл -->
                    <label class="sidebar-radio-row">
                      <input
                        type="radio"
                        name="dataSource"
                        id="dataSourceFile"
                        value="file"
                        checked
                      />
                      <span>Файл Telegram (JSON)</span>
                    </label>

                    <!-- 2. Мой аккаунт Telegram -->
                    <label class="sidebar-radio-row">
                      <input
                        type="radio"
                        name="dataSource"
                        id="dataSourceAccount"
                        value="account"
                      />
                      <span>Мой аккаунт Telegram</span>
                    </label>

                    <!-- Блок: Авторизация Telegram (появляется под "Мой аккаунт") -->
                    <div
                      id="tgAuthBlock"
                      class="tg-auth-block"
                      style="display: none;"
                    >
                      <h3>Авторизация Telegram</h3>

                      <!-- состояние 1: ввод телефона -->
                      <div id="tgStatePhone">
                        <div class="tg-field">
                          <label for="tgPhoneInput">Телефон</label>
                          <input
                            id="tgPhoneInput"
                            type="text"
                            class="tg-input"
                            placeholder="+7 9ХХ ХХХ-ХХ-ХХ"
                          />
                        </div>
                        <button
                          id="tgSendCodeBtn"
                          type="button"
                          class="tg-button"
                        >
                          Получить код в Telegram
                        </button>
                        <p class="tg-status">
                          Мы отправим код в ваш Telegram-клиент. Мы не сохраняем
                          историю сообщений.
                        </p>
                      </div>

                      <!-- состояние 2: ввод кода -->
                      <div id="tgStateCode" style="display: none;">
                        <p class="tg-status">
                          Мы отправили код в ваш Telegram. Введите его ниже.
                        </p>
                        <div class="tg-field">
                          <label for="tgCodeInput">Код из Telegram</label>
                          <input
                            id="tgCodeInput"
                            type="text"
                            class="tg-input"
                            placeholder="12345"
                          />
                        </div>
                        <button
                          id="tgConfirmCodeBtn"
                          type="button"
                          class="tg-button"
                        >
                          Подтвердить код
                        </button>
                        <button
                          id="tgCancelCodeBtn"
                          type="button"
                          class="tg-button"
                          style="margin-left: 4px;"
                        >
                          Отменить
                        </button>
                      </div>

                      <!-- состояние 2.5: требуется пароль Telegram (2FA) -->
                      <div id="tgStatePassword" style="display: none;">
                        <p class="tg-status">
                          Для завершения входа требуется пароль Telegram (2FA).
                        </p>
                      
                        <div class="tg-field">
                          <label for="tgPasswordInput">Пароль Telegram</label>
                          <input
                            id="tgPasswordInput"
                            type="password"
                            class="tg-input"
                            placeholder="Введите пароль"
                          />
                        </div>
                      
                        <button
                          id="tgConfirmPasswordBtn"
                          type="button"
                          class="tg-button"
                        >
                          Подтвердить пароль
                        </button>
                      </div>

                      <!-- состояние 3: подключено -->
                      <div id="tgStateConnected" style="display: none;">
                        <p class="tg-status">
                          Подключено к Telegram как
                          <strong id="tgConnectedUser">@username</strong>.
                        </p>
                        <p class="tg-status">
                          В следующем шаге здесь появится список ваших чатов для
                          анализа.
                        </p>
                      </div>

                      <p id="tgStatusMessage" class="tg-status"></p>
                    </div>

                    <!-- 3. Публичный канал -->
                    <label class="sidebar-radio-row">
                      <input
                        type="radio"
                        name="dataSource"
                        id="dataSourcePublic"
                        value="public"
                      />
                      <span>Публичный канал (без логина)</span>
                    </label>

                    <!-- 4. Чат с ботом -->
                    <label class="sidebar-radio-row">
                      <input
                        type="radio"
                        name="dataSource"
                        id="dataSourceBot"
                        value="bot"
                      />
                      <span>Чат с ботом</span>
                    </label>
                  </div>
                </details>
              </div>
            </div>
            </aside>

           <div class="dashboard-container">
              <div class="dashboard-top-block">

              <!-- Полоска заголовка чата -->
              <div id="chatTitleBar" class="chat-title-bar" style="display:none;">
                  <span id="chatTitleText"></span>
              </div>
              <div class="dashboard-results-viewer">
                
                <div class="dashboard-loader">
                  <div class="dashboard-loader-cat">
                    <div class="dashboard-cat-body">
                      <div
                        class="dashboard-cat-ear dashboard-cat-ear-left"
                      ></div>
                      <div
                        class="dashboard-cat-ear dashboard-cat-ear-right"
                      ></div>
                      <div class="dashboard-cat-face">
                        <div
                          class="dashboard-cat-eye dashboard-cat-eye-left"
                        ></div>
                        <div
                          class="dashboard-cat-eye dashboard-cat-eye-right"
                        ></div>
                        <div class="dashboard-cat-nose"></div>
                      </div>
                    </div>
                    <div class="dashboard-cat-tail"></div>
                  </div>
                  <p class="dashboard-loader-text section-content">
                    Анализируем ваши данные...
                  </p>
                </div>
                 <pre id="analysisResult" class="dashboard-results-text"></pre>
              </div>
            </div>
            <div class="dashboard-bottom-block">
              <div class="dashboard-input-panel">
                <div class="analysis-controls">
                  <!-- Кнопка импорта чата -->
                  <button
                    id="uploadBtn"
                    class="analysis-icon-button"
                    type="button"
                    title="Импорт чата"
                  >
                    <!-- reuse SVG загрузки из старой разметки -->
                    <svg
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M12 3v12m5-7l-5-5l-5 5m14 7v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </button>

                  <!-- Скрытый input файла -->
                  <input type="file" id="chatFile" accept=".json" style="display:none" />
            
                  <!-- Овальное поле запроса -->
                  <input
                    id="queryInput"
                    type="text"
                    class="analysis-query-input"
                    placeholder="Введите текст запроса"
                  />
            
                  <!-- Кнопка play -->
                  <button
                    id="analyzeBtn"
                    class="analysis-icon-button analysis-play-button"
                    type="button"
                    title="Выполнить анализ"
                  >
                    <svg
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                  d="M8 5v14l11-7z"
                  fill="currentColor"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linejoin="round"
                />
                    </svg>
                  </button>
                </div>

                <!-- Здесь маленький дисклеймер под панелью ввода -->
                <p class="analysis-disclaimer">
                  ⚠️ Анализ чата выполняется сторонней моделью ИИ (OpenAI).
                  Не загружайте секретные или конфиденциальные данные.
                </p>
              </div>
            </div>
          </div>
        </div>
          
        <style>
          @keyframes dashboardFloat { 0%,100% {transform: translateY(0) rotate(0deg);} 50% {transform: translateY(-20px) rotate(5deg);} }
          @keyframes dashboardBlink { 0%,48%,52%,100% {height: 8px;} 50% {height: 2px;} }
          @keyframes dashboardTailWag { 0%,100% {transform: rotate(-45deg);} 50% {transform: rotate(-25deg);} }
          @keyframes dashboardPulse { 0%,100% {opacity: 1;} 50% {opacity: 0.5;} }
        </style>
      
        <script defer data-name="dashboard-interactions">
  document.addEventListener("DOMContentLoaded", function () {
    (function () {
      const BACKEND_URL = "https://cotel-backend.onrender.com/analyze";

      const uploadBtn = document.getElementById("uploadBtn");
      const fileInput = document.getElementById("chatFile");
      const queryInput = document.getElementById("queryInput");
      const analyzeBtn = document.getElementById("analyzeBtn");
      const loader = document.querySelector(".dashboard-loader");
      const resultDiv = document.getElementById("analysisResult");

            // --- ЭЛЕМЕНТЫ ДЛЯ ВЫБОРА ИСТОЧНИКА ДАННЫХ ---
      const dataSourceFileRadio = document.getElementById("dataSourceFile");
      const dataSourceAccountRadio = document.getElementById("dataSourceAccount");
      const dataSourcePublicRadio = document.getElementById("dataSourcePublic");
      const dataSourceBotRadio = document.getElementById("dataSourceBot");

      const tgAuthBlock = document.getElementById("tgAuthBlock");
      const tgStatePhone = document.getElementById("tgStatePhone");
      const tgStateCode = document.getElementById("tgStateCode");
      const tgStateConnected = document.getElementById("tgStateConnected");

      const tgStatePassword = document.getElementById("tgStatePassword");
      const tgPasswordInput = document.getElementById("tgPasswordInput");
      const tgConfirmPasswordBtn = document.getElementById("tgConfirmPasswordBtn");

      const tgPhoneInput = document.getElementById("tgPhoneInput");
      const tgSendCodeBtn = document.getElementById("tgSendCodeBtn");
      const tgCodeInput = document.getElementById("tgCodeInput");
      const tgConfirmCodeBtn = document.getElementById("tgConfirmCodeBtn");
      const tgCancelCodeBtn = document.getElementById("tgCancelCodeBtn");
      const tgStatusMessage = document.getElementById("tgStatusMessage");
      const tgConnectedUser = document.getElementById("tgConnectedUser");

      // элементы для сворачиваемой левой панели
      const sidebar = document.querySelector(".dashboard-sidebar");
      const sidebarToggle = document.getElementById("sidebarToggle");

            // ----------------------
      // МАСКА ДЛЯ ТЕЛЕФОНА +7
      // ----------------------
      tgPhoneInput.addEventListener("input", function (e) {
        let value = tgPhoneInput.value.replace(/\D/g, ""); // только цифры
      
        // Начинаем всегда с "7"
        if (!value.startsWith("7")) {
          value = "7" + value;
        }
      
        // Ограничиваем длину до 11 цифр
        value = value.substring(0, 11);
      
        // Форматируем
        let formatted = "+7";
      
        if (value.length > 1) formatted += " " + value.substring(1, 4);
        if (value.length > 4) formatted += " " + value.substring(4, 7);
        if (value.length > 7) formatted += " " + value.substring(7, 9);
        if (value.length > 9) formatted += " " + value.substring(9, 11);
      
        tgPhoneInput.value = formatted;
      });
      
      // Не даём удалить "+7"
      tgPhoneInput.addEventListener("keydown", (e) => {
        if (tgPhoneInput.selectionStart < 2 && (e.key === "Backspace" || e.key === "Delete")) {
          e.preventDefault();
        }
      });

      function updateDataSourceUI() {
        const checked = document.querySelector('input[name="dataSource"]:checked');
        const mode = checked ? checked.value : "file";

        // показываем / скрываем кнопку загрузки файла
        if (uploadBtn) {
          uploadBtn.style.display = mode === "file" ? "inline-flex" : "none";
        }

        // показываем / скрываем блок авторизации Telegram
        if (tgAuthBlock) {
          tgAuthBlock.style.display = mode === "account" ? "block" : "none";
        }
      }

      function setTgState(state) {
        tgStatePhone.style.display = state === "phone" ? "block" : "none";
        tgStateCode.style.display = state === "code" ? "block" : "none";
        tgStatePassword.style.display = state === "password" ? "block" : "none";
        tgStateConnected.style.display = state === "connected" ? "block" : "none";
      }


      // начальное состояние
      setTgState("phone");

      function showLoader(show) {
        if (!loader) return;
        loader.style.display = show ? "flex" : "none";
      }

      // по умолчанию прячем котика
      showLoader(false);

            // по умолчанию обновляем UI по выбранному источнику
      updateDataSourceUI();

      // слушаем переключение источника данных
      dataSourceFileRadio?.addEventListener("change", updateDataSourceUI);
      dataSourceAccountRadio?.addEventListener("change", updateDataSourceUI);
      dataSourcePublicRadio?.addEventListener("change", updateDataSourceUI);
      dataSourceBotRadio?.addEventListener("change", updateDataSourceUI);

      // --- Сворачивание / разворачивание левой панели ---
      if (sidebar && sidebarToggle) {
        sidebarToggle.addEventListener("click", () => {
          const isCollapsed = sidebar.classList.toggle("collapsed");
          sidebarToggle.setAttribute(
            "title",
            isCollapsed ? "Развернуть панель" : "Свернуть панель"
          );
        });
      }

      // --- ПОВЕДЕНИЕ БЛОКА АВТОРИЗАЦИИ TELEGRAM (пока без реальных запросов) ---

      tgSendCodeBtn?.addEventListener("click", async () => {
      const phone = (tgPhoneInput?.value || "").trim();
      if (!phone) {
        tgStatusMessage.textContent = "Введите номер телефона.";
        return;
      }
    
      tgStatusMessage.textContent = "Отправляем код...";
    
      try {
        const resp = await fetch("https://cotel-backend.onrender.com/tg/send_code", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ phone })
        });
    
        const data = await resp.json();
    
        if (!resp.ok) {
          tgStatusMessage.textContent = "Ошибка: " + (data.detail || "Не удалось отправить код.");
          return;
        }
    
        tgStatusMessage.textContent = "Код отправлен. Проверьте Telegram.";
        setTgState("code");
    
      } catch (err) {
        tgStatusMessage.textContent = "Ошибка сети: " + err.message;
      }
      });


      tgConfirmCodeBtn?.addEventListener("click", async () => {
      const phone = (tgPhoneInput?.value || "").trim();
      const code = (tgCodeInput?.value || "").trim();
    
      if (!code) {
        tgStatusMessage.textContent = "Введите код из Telegram.";
        return;
      }
    
      tgStatusMessage.textContent = "Проверяем код...";
    
      try {
        const resp = await fetch("https://cotel-backend.onrender.com/tg/confirm_code", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ phone, code })
        });
    
        const data = await resp.json();
    
       const detail = String(data.detail || "");

        if (!resp.ok) {
          if (detail.includes("SESSION_PASSWORD_NEEDED") || detail.includes("PASSWORD_NEEDED")) {
            tgStatusMessage.textContent = "Требуется пароль Telegram (2FA).";
            setTgState("password");
            return;
        }
      
        tgStatusMessage.textContent = "Ошибка: " + (data.detail || "Код неверен.");
        return;
      }


    // успешная авторизация
    tgConnectedUser.textContent = data.username
      ? "@" + data.username
      : data.first_name || "Пользователь";

    tgStatusMessage.textContent = "Успешно подключено.";

    setTgState("connected");

  } catch (err) {
    tgStatusMessage.textContent = "Ошибка сети: " + err.message;
  }
});

      tgConfirmPasswordBtn?.addEventListener("click", async () => {
        const phone = (tgPhoneInput?.value || "").trim();
        const password = (tgPasswordInput?.value || "").trim();
      
        if (!password) {
          tgStatusMessage.textContent = "Введите пароль Telegram.";
          return;
        }
      
        tgStatusMessage.textContent = "Подтверждаем пароль...";
      
        try {
          const resp = await fetch("https://cotel-backend.onrender.com/tg/confirm_password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ phone, password })
          });
      
          const data = await resp.json();
      
          if (!resp.ok) {
            tgStatusMessage.textContent = "Ошибка: " + (data.detail || "Не удалось подтвердить пароль.");
            return;
          }
      
          tgConnectedUser.textContent = data.username
            ? "@" + data.username
            : data.first_name || "Пользователь";
      
          tgStatusMessage.textContent = "Успешно подключено.";
          setTgState("connected");
      
        } catch (err) {
          tgStatusMessage.textContent = "Ошибка сети: " + err.message;
        }
      });

      tgCancelCodeBtn?.addEventListener("click", () => {
        if (tgPhoneInput) tgPhoneInput.value = "";
        if (tgCodeInput) tgCodeInput.value = "";
        if (tgStatusMessage) tgStatusMessage.textContent = "";
        setTgState("phone");
      });

      // клик по кнопке с иконкой → открываем выбор файла
      if (uploadBtn && fileInput) {
      uploadBtn.addEventListener("click", () => {
    // важная строка: сбрасываем выбранный файл,
    // чтобы даже тот же самый файл считался "изменением"
    fileInput.value = "";
    fileInput.click();
  });

  fileInput.addEventListener("change", () => {
    if (!fileInput.files[0]) return;
    if (resultDiv) {
      resultDiv.textContent = `Выбран файл: ${fileInput.files[0].name}`;
    }
  
  });
}

      // запуск анализа по кнопке Play
      if (analyzeBtn) {
        analyzeBtn.addEventListener("click", async () => {
          const file = fileInput?.files[0];

          if (!file) {
            alert("Сначала импортируйте чат (выберите JSON-файл экспорта)");
            return;
          }

          const query = (queryInput?.value || "").trim();

          const formData = new FormData();
          formData.append("file", file);

          const params = {
            query: query || null,
            result_type: "summary",
          };
          formData.append("params", JSON.stringify(params));

          showLoader(true);
          if (resultDiv) resultDiv.textContent = "";

          try {
            const resp = await fetch(BACKEND_URL, {
              method: "POST",
              body: formData,
            });
          
            // 1. сначала читаем "сырое" тело
            const rawText = await resp.text();
            let data = null;
          
            // 2. пробуем распарсить как JSON, если что — игнорируем
            if (rawText) {
              try {
                data = JSON.parse(rawText);
              } catch (e) {
                // не JSON — ничего страшного, будем работать с текстом
              }
            }

            // 3. если статус не ок — показываем максимум информации
            if (!resp.ok) {
              const detail =
                (data && (data.detail || data.error)) ||
                rawText ||
                resp.statusText ||
                "Неизвестная ошибка";
          
              if (resultDiv) {
                resultDiv.textContent =
                  "Ошибка сервера (" + resp.status + "): " + detail;
              }
              return;
            }
          
            // 4. если вообще пусто — отдельно подсветим
            if (!data && !rawText) {
              if (resultDiv) {
                resultDiv.textContent =
                  "Сервер вернул пустой ответ (status " + resp.status + ").";
              }
              return;
            }

            // 5. нормальный успешный ответ
            const payload = data || {};
          
            let text = "";

            // 1) сначала сам ответ LLM, если есть
            if (payload.summary) {
              text += payload.summary + "\n\n";
            }
            
            // 2) затем служебное сообщение
            if (payload.message) {
              text += payload.message;
            } else if (payload.status === "ok" && !payload.summary) {
              text += "Файл успешно загружен";
            }
          
            if (typeof payload.messages_count === "number") {
              text += ` (сообщений: ${payload.messages_count})`;
            }
          
            if (payload.filename) {
              text += `\nФайл: ${payload.filename}`;
            }
          
            // показать тип и название чата в верхней полоске
            if (payload.chat_name || payload.chat_type) {
            const bar = document.getElementById("chatTitleBar");
            const title = document.getElementById("chatTitleText");
          
            const typeText = payload.chat_type ? payload.chat_type : "Чат";
            const nameText = payload.chat_name ? payload.chat_name : "Без названия";

            title.textContent = `${typeText}: ${nameText}`;
            bar.style.display = "block";
          }
            if (resultDiv) {
              resultDiv.textContent = text || rawText;
            }
        } catch (err) {
          if (resultDiv) {
            resultDiv.textContent = "Ошибка запроса: " + err.message;
          }
} finally {
  showLoader(false);
}

        });
      }
    })();
  });
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const header = document.getElementById("mainNav");
  if (!header) return;

  const HOTZONE_HEIGHT = 40;    // сколько пикселей от верха — «горячая зона»
  const HIDE_DELAY = 1500;      // через сколько мс прятать после показа

  let hideTimer = null;

  function hideHeader() {
    header.classList.add("nav-hidden");
  }

  function scheduleHide() {
    clearTimeout(hideTimer);
    hideTimer = setTimeout(hideHeader, HIDE_DELAY);
  }

  // старт: через небольшую паузу шапка уедет
  scheduleHide();

  // Показ только если мышка у самого верха окна
  document.addEventListener("mousemove", (e) => {
    // e.clientY — позиция курсора от верха окна
    if (e.clientY <= HOTZONE_HEIGHT) {
      header.classList.remove("nav-hidden");
      scheduleHide();  // обновляем таймер скрытия
    }
    // если мышка ниже — ничего не делаем, шапка сама скроется по таймеру
  });

  // Чуть-чуть улучшим поведение при скролле:
  // при активном скролле просто обновляем таймер скрытия,
  // но сам хедер НЕ показываем
  window.addEventListener("scroll", () => {
    scheduleHide();
  });
});
</script>



      <link
        rel="canonical"
        href="https://single-sane-falcon-xjmc7x.teleporthq.app/new-analysis"
      />
    </div>
  </body>
</html>
