<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Work area</title>
    <link rel="icon" type="image/png" href="images/cotel-cat.png">
    <meta property="og:title" content="New-Analysis - Single Sane Falcon" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8" />
    <meta property="twitter:card" content="summary_large_image" />

    <style data-tag="reset-style-sheet">
      html {  line-height: 1.15;}body {  margin: 0;}* {  box-sizing: border-box;  border-width: 0;  border-style: solid;  -webkit-font-smoothing: antialiased;}p,li,ul,pre,div,h1,h2,h3,h4,h5,h6,figure,blockquote,figcaption {  margin: 0;  padding: 0;}button {  background-color: transparent;}button,input,optgroup,select,textarea {  font-family: inherit;  font-size: 100%;  line-height: 1.15;  margin: 0;}button,select {  text-transform: none;}button,[type="button"],[type="reset"],[type="submit"] {  -webkit-appearance: button;  color: inherit;}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner {  border-style: none;  padding: 0;}button:-moz-focus,[type="button"]:-moz-focus,[type="reset"]:-moz-focus,[type="submit"]:-moz-focus {  outline: 1px dotted ButtonText;}a {  color: inherit;  text-decoration: inherit;}pre {  white-space: normal;}input {  padding: 2px 4px;}img {  display: block;}details {  display: block;  margin: 0;  padding: 0;}summary::-webkit-details-marker {  display: none;}[data-thq="accordion"] [data-thq="accordion-content"] {  max-height: 0;  overflow: hidden;  transition: max-height 0.3s ease-in-out;  padding: 0;}[data-thq="accordion"] details[data-thq="accordion-trigger"][open] + [data-thq="accordion-content"] {  max-height: 1000vh;}details[data-thq="accordion-trigger"][open] summary [data-thq="accordion-icon"] {  transform: rotate(180deg);}html { scroll-behavior: smooth  }
    </style>
    <style data-tag="default-style-sheet">
      html {
        font-family: "Noto Sans";
        font-size: 1rem;
      }

    
      body {
        font-weight: 400;
        font-style:normal;
        text-decoration: undefined;
        text-transform: undefined;
        letter-spacing: 0.01em;
        line-height: 1.6;
        color: var(--color-on-surface);
        background: var(--color-surface);

        fill: var(--color-on-surface);
      }
    </style>

      <style>
      /* –õ–µ–π–∞—É—Ç: —Å–ª–µ–≤–∞ —Å–∞–π–¥–±–∞—Ä, —Å–ø—Ä–∞–≤–∞ —Ä–∞–±–æ—á–∞—è  –æ–±–ª–∞—Å—Ç—å */
      .dashboard-layout {
        display: flex;
        align-items:  flex-start;
      }

      /* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ */
      .dashboard-sidebar {
        width: 300px;
        padding: 16px 20px;
        border-right: 1px solid rgba(0, 0, 0, 0.06);
        /* background: #f9fafb;*/
        background: #f3f4f6; /* –º—è–≥–∫–∏–π —Å–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π */
        font-size: 0.9rem;
      }

      .dashboard-sidebar h3 {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .sidebar-section {
        margin-bottom: 18px;
      }

      .sidebar-section details {
        border-radius: 8px;
        padding: 8px 10px;
        background: #ffffff;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.04);
      }

      .sidebar-section summary {
        list-style: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: 600;
      }

      .sidebar-section summary::-webkit-details-marker {
        display: none;
      }

      .sidebar-section-body {
        margin-top: 8px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .sidebar-radio-row {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .sidebar-radio-row input[type="radio"] {
        margin: 0;
      }

        .tg-auth-block {
        margin: 6px 0 10px 22px;      /* —á—É—Ç—å —Å–¥–≤–∏–≥–∞–µ–º –≤–ø—Ä–∞–≤–æ + –Ω–∏–∂–Ω–∏–π –æ—Ç—Å—Ç—É–ø */
        padding: 12px 14px;
        border-radius: 12px;
        background: #fdfcf8;          /* –º–æ–ª–æ—á–Ω–æ-–±–µ–ª—ã–π */
        border: 1px solid #e5e7eb;    /* —Ç–æ–Ω–∫–∞—è —Å–µ—Ä–∞—è —Ä–∞–º–∫–∞ */
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.04);
      }

      .tg-field {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-bottom: 10px;
        padding: 6px 8px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.7); /* –ª—ë–≥–∫–∞—è –ø–ª–∞—à–∫–∞ –ø–æ–¥ –ø–æ–ª—è–º–∏ */
      }


      .tg-input {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid #d1d5db;
        font-size: 0.9rem;
      }

      .tg-button {
        margin-top: 4px;
        padding: 6px 14px;
        border-radius: 999px;
        border: 1px solid #d1d5db;
        background: #f3f4f6;
        cursor: pointer;
        font-size: 0.85rem;
      }

      .tg-button:hover {
        background: #e5e7eb;
      }

      .tg-status {
        font-size: 0.8rem;
        color: #6b7280;
        margin-top: 4px;
      }

      .dashboard-container {
        flex: 1;
      }

      @media (max-width: 900px) {
        .dashboard-layout {
          flex-direction: column;
        }

        .dashboard-sidebar {
          width: 100%;
          border-right: none;
          border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }
      }
    </style>

    <link
      rel="stylesheet"
      href="https://unpkg.com/animate.css@4.1.1/animate.css"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap"
      data-tag="font"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap"
      data-tag="font"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=STIX+Two+Text:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&amp;display=swap"
      data-tag="font"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap"
      data-tag="font"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/@teleporthq/teleport-custom-scripts/dist/style.css"
    />
  </head>
  <body>
    <link rel="stylesheet" href="./style.css" />
      <link href="./new-analysis.css" rel="stylesheet" />

      <div class="new-analysis-container1">
        <navigation-wrapper class="navigation-wrapper">
          <!--Navigation component-->
          <div class="navigation-container1">
            <div class="navigation-container2">
              <div class="navigation-container3">
                <style>
                  @media (prefers-reduced-motion: reduce) {
                  .navigation__link::after, .navigation__logo::before, .navigation__overlay-link::before {
                    transition: none;
                  }
                  .navigation__overlay-link {
                    animation: none;
                  }
                  .navigation__logo:hover .navigation__logo-icon {
                    transform: none;
                  }
                  }
                </style>
              </div>
            </div>
            <nav id="mainNav" class="navigation">
              <div class="navigation__container">
                <div class="navigation__left">
                  <a href="#">
                    <div class="navigation__link">
                      <span>–ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑</span>
                    </div>
                  </a>
                  <a href="#">
                    <div class="navigation__link"><span>–ò—Å—Ç–æ—Ä–∏—è</span></div>
                  </a>
                </div>

                  <div class="navigation__logo">
                   
                    <span class="section-title navigation__logo-text">
  CO
  <img
    src="images/cotel-cat.png"
    alt="CoTel logo"
    class="navigation-logo-cat"
  />
  TEL
</span>
                  </div>

                <div class="navigation__right">
                  <a href="#">
                    <div class="navigation__link"><span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></div>
                  </a>
                  <a href="#">
                    <div class="navigation__link navigation__link--cta">
                      <span>–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å</span>
                    </div>
                  </a>
                </div>
               
              </div>
            </nav>
            <div id="navOverlay" class="navigation__overlay">
              <div class="navigation__overlay-header">
                <a href="#">
                  <div class="navigation__overlay-logo">
                    
                    <span class="section-title">COTEL</span>
                  </div>
                </a>
                <button
                  id="navClose"
                  aria-label="–ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é"
                  class="navigation__overlay-close"
                >
                  <svg
                    width="28"
                    xmlns="http://www.w3.org/2000/svg"
                    height="28"
                    viewBox="0 0 24 24"
                  >
                    <path
                      d="m18 6l-12 12M6 6l12 12"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    ></path>
                  </svg>
                </button>
              </div>
              <div class="navigation__overlay-content">
                <a href="#">
                  <div class="navigation__overlay-link">
                    <span>–ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑</span>
                  </div>
                </a>
                <a href="#">
                  <div class="navigation__overlay-link">
                    <span>–ò—Å—Ç–æ—Ä–∏—è</span>
                  </div>
                </a>
                <a href="#">
                  <div class="navigation__overlay-link">
                    <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                  </div>
                </a>
                <a href="#">
                  <div
                    class="navigation__overlay-link--cta navigation__overlay-link"
                  >
                    <span>–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å</span>
                  </div>
                </a>
              </div>
            </div>
            <div class="navigation-container4">
              <div class="navigation-container5">
                <style>
                          @keyframes slideIn {from {opacity: 0;
                  transform: translateY(-20px);}
                  to {opacity: 1;
                  transform: translateY(0);}}
                </style>
              </div>
            </div>
          
          </div>
        </navigation-wrapper>
        
        <div class="dashboard-main">

          <div class="dashboard-layout">
            <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö + –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è --> 
           <aside class="dashboard-sidebar">

            <div class="sidebar-header">
              <button
                id="sidebarToggle"
                class="sidebar-toggle-btn"
                type="button"
                title="–°–≤–µ—Ä–Ω—É—Ç—å –ø–∞–Ω–µ–ª—å"
              >
              ‚öôÔ∏è
              </button>
              <span class="sidebar-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            </div>

            <!-- –ú–∏–Ω–∏-–∏–∫–æ–Ω–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Å–≤–µ—Ä–Ω—É—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ -->
            <div class="sidebar-mini-icons">
              <button
                class="sidebar-mini-icon-btn"
                type="button"
                data-target="dataSourceSection"
                title="–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö"
              >
                üìÅ
              </button>
              <button
                class="sidebar-mini-icon-btn"
                type="button"
                title="Telegram"
              >
                <span id="tgMiniStatusDot" class="tg-status-dot tg-status-off"></span>
              </button>

              <button
                class="sidebar-mini-icon-btn"
                type="button"
                data-target="myChatsSection"
                title="–ú–æ–∏ —á–∞—Ç—ã"
              >
                üí¨
              </button>
              <button
                class="sidebar-mini-icon-btn"
                type="button"
                data-target="mySubscriptionsSection"
                title="–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏"
              >
                ‚≠ê
              </button>
            </div>

             
             <!-- –í–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø–∞–Ω–µ–ª–∏ -->
              <div id="sidebarContent">
                <!-- 1. –ò–°–¢–û–ß–ù–ò–ö –î–ê–ù–ù–´–• -->
              <div class="sidebar-section">
                <details id="dataSourceSection" open>
                  <summary>
                    <span>–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö</span>
                    <span>‚ñæ</span>
                  </summary>

                  <div class="sidebar-section-body">
                    <!-- 1. –§–∞–π–ª -->
                    <label class="sidebar-radio-row">
                      <input
                        type="radio"
                        name="dataSource"
                        id="dataSourceFile"
                        value="file"
                        checked
                      />
                      <span>–§–∞–π–ª Telegram (JSON)</span>
                    </label>

                    <!-- 2. –ú–æ–π –∞–∫–∫–∞—É–Ω—Ç Telegram -->
                    <label class="sidebar-radio-row">
                      <input
                        type="radio"
                        name="dataSource"
                        id="dataSourceAccount"
                        value="account"
                      />
                      <span>–ú–æ–π –∞–∫–∫–∞—É–Ω—Ç Telegram</span>
                    </label>

                    <!-- –ë–ª–æ–∫: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Telegram (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ–¥ "–ú–æ–π –∞–∫–∫–∞—É–Ω—Ç") -->
                    <div
                      id="tgAuthBlock"
                      class="tg-auth-block"
                      style="display: none;"
                    >
                      <h3>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Telegram</h3>

                      <!-- QR login -->
                      <div id="tgQrBlock" class="tg-qr-block">
                        <button id="tgQrStartBtn" type="button" class="tg-button">
                          –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ QR-–∫–æ–¥
                        </button>

                        <div id="tgQrArea" class="tg-qr-area" style="display:none;">
                          <div id="tgQrCanvas" class="tg-qr-canvas"></div>
                          <p id="tgQrHint" class="tg-status">–û—Ç–∫—Ä–æ–π—Ç–µ Telegram ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ‚Üí –ü–æ–¥–∫–ª—é—á–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ —Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR.</p>
                          <p id="tgQrStatus" class="tg-status"></p>

                          <button id="tgQrRestartBtn" type="button" class="tg-button" style="display:none;">
                            –û–±–Ω–æ–≤–∏—Ç—å QR
                          </button>
                        </div>

                        <div class="tg-qr-divider"></div>
                      </div>


                      <!-- —Å–æ—Å—Ç–æ—è–Ω–∏–µ 1: –≤–≤–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ -->
                      <div id="tgStatePhone">
                        <div class="tg-field">
                          <label for="tgPhoneInput">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                          <input
                            id="tgPhoneInput"
                            type="text"
                            class="tg-input"
                            placeholder="+7 9–•–• –•–•–•-–•–•-–•–•"
                          />
                        </div>
                        <button
                          id="tgSendCodeBtn"
                          type="button"
                          class="tg-button"
                        >
                          –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –≤ Telegram
                        </button>
                        <p class="tg-status">
                          –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º –∫–æ–¥ –≤ –≤–∞—à Telegram-–∫–ª–∏–µ–Ω—Ç. –ú—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
                          –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π.
                        </p>
                      </div>

                      <!-- —Å–æ—Å—Ç–æ—è–Ω–∏–µ 2: –≤–≤–æ–¥ –∫–æ–¥–∞ -->
                      <div id="tgStateCode" style="display: none;">
                        <p class="tg-status">
                          –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∫–æ–¥ –≤ –≤–∞—à Telegram. –í–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ.
                        </p>
                        <div class="tg-field">
                          <label for="tgCodeInput">–ö–æ–¥ –∏–∑ Telegram</label>
                          <input
                            id="tgCodeInput"
                            type="text"
                            class="tg-input"
                            placeholder="12345"
                          />
                        </div>
                        <button
                          id="tgConfirmCodeBtn"
                          type="button"
                          class="tg-button"
                        >
                          –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥
                        </button>
                        <button
                          id="tgCancelCodeBtn"
                          type="button"
                          class="tg-button"
                          style="margin-left: 4px;"
                        >
                          –û—Ç–º–µ–Ω–∏—Ç—å
                        </button>
                      </div>

                      <!-- —Å–æ—Å—Ç–æ—è–Ω–∏–µ 2.5: —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å Telegram (2FA) -->
                      <div id="tgStatePassword" style="display: none;">
                        <p class="tg-status">
                          –î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Ö–æ–¥–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å Telegram (2FA).
                        </p>
                      
                        <div class="tg-field">
                          <label for="tgPasswordInput">–ü–∞—Ä–æ–ª—å Telegram</label>
                          <input
                            id="tgPasswordInput"
                            type="password"
                            class="tg-input"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                          />
                        </div>
                      
                        <button
                          id="tgConfirmPasswordBtn"
                          type="button"
                          class="tg-button"
                        >
                          –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–∞—Ä–æ–ª—å
                        </button>
                      </div>

                      <!-- —Å–æ—Å—Ç–æ—è–Ω–∏–µ 3: –ø–æ–¥–∫–ª—é—á–µ–Ω–æ -->
                      <div id="tgStateConnected" style="display: none;">
                        <p class="tg-status">
                          –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Telegram –∫–∞–∫
                          <strong id="tgConnectedUser">@username</strong>.
                        </p>

                      </div>

                      <p id="tgStatusMessage" class="tg-status"></p>
                    </div>

                    <!-- 3. –ü—É–±–ª–∏—á–Ω—ã–π –∫–∞–Ω–∞–ª -->
                    <label class="sidebar-radio-row">
                      <input
                        type="radio"
                        name="dataSource"
                        id="dataSourcePublic"
                        value="public"
                      />
                      <span>–ü—É–±–ª–∏—á–Ω—ã–π –∫–∞–Ω–∞–ª (–±–µ–∑ –ª–æ–≥–∏–Ω–∞)</span>
                    </label>

                    <!-- 4. –ß–∞—Ç —Å –±–æ—Ç–æ–º -->
                    <label class="sidebar-radio-row">
                      <input
                        type="radio"
                        name="dataSource"
                        id="dataSourceBot"
                        value="bot"
                      />
                      <span>–ß–∞—Ç —Å –±–æ—Ç–æ–º</span>
                    </label>
                  </div>
                </details>
              </div>

              <!-- 1.5 –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø TELEGRAM (–°–¢–ê–¢–£–°) -->
              <div class="sidebar-section" id="telegramStatusSection" style="display:none;">
                <details open>
                  <summary>
                    <span>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram</span>
                    <span>‚ñæ</span>
                  </summary>
              
                  <div class="sidebar-section-body">
                    <div class="tg-status-row">
                      <span id="tgStatusDot" class="tg-status-dot tg-status-off"></span>
                      <span id="tgStatusText">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
                    </div>
              
                    <p class="sidebar-hint">
                      –ê–∫–∫–∞—É–Ω—Ç:
                      <strong id="tgStatusUsername">‚Äî</strong>
                    </p>

                    <button
                      id="tgLogoutBtnStatus"
                      type="button"
                      class="tg-button"
                      style="margin-top: 8px; display: none;"
                    >
                      –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ–∞–Ω—Å
                    </button>

                  </div>
                </details>
              </div>

              <!-- –ù–ê–°–¢–†–û–ô–ö–ò –ó–ê–ü–†–û–°–ê -->
              <div class="sidebar-section" id="querySettingsSection">
                <details>
                  <summary>
                    <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–ø—Ä–æ—Å–∞</span>
                    <span>‚ñæ</span>
                  </summary>
              
                  <div class="sidebar-section-body">
                    <div class="sidebar-field">
                      <label for="queryDaysInput">–ü–µ—Ä–∏–æ–¥ (–¥–Ω–µ–π)</label>
                      <input
                        id="queryDaysInput"
                        type="number"
                        class="sidebar-text-input"
                        min="1"
                        max="365"
                        value="7"
                      />
                    </div>
                  </div>
                </details>
              </div>

                
               <!-- 2. –ú–û–ò –ß–ê–¢–´ -->
              <div class="sidebar-section">
                <details id="myChatsSection" open>
                  <summary>
                    <span>–ú–æ–∏ —á–∞—Ç—ã</span>
                    <span>‚ñæ</span>
                  </summary>
          
                  <div class="sidebar-section-body">
                    <label class="sidebar-field-label" for="">
                      –ê–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
                    </label>
                   <input
                    id="activeChatInput"
                    type="text"
                    class="sidebar-text-input"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞‚Ä¶"
                  />
                  
                  <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
                  <div id="myChatsList" class="sidebar-chat-list" aria-label="–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤"></div>

                  </div>
                </details>
              </div>
          
              <!-- 3. –ú–û–ò –ü–û–î–ü–ò–°–ö–ò -->
              <div class="sidebar-section">
                <details id="mySubscriptionsSection" open>
                  <summary>
                    <span>–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏</span>
                    <span>‚ñæ</span>
                  </summary>
          
                  <div class="sidebar-section-body sidebar-subscriptions-body">
                    <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
                    <button
                      id="addSubscriptionBtn"
                      type="button"
                      class="sidebar-add-subscription-btn"
                      title="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"
                    >
                      +
                    </button>

                    <!-- –°–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å–æ–∫ (–ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–∞—è –∑–∞–≥–ª—É—à–∫–∞) -->
                    <div id="subscriptionsList" class="sidebar-subscriptions-list" aria-label="–°–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å–æ–∫"></div>

                    <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ (—Å–∫—Ä—ã—Ç–∞ –¥–æ –Ω–∞–∂–∞—Ç–∏—è +) -->
                    <div id="subscriptionCreateBlock" class="tg-auth-block subscription-block" style="display:none;">
                      <h3>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏</h3>

                      <div class="tg-field">
                        <label for="subNameInput">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏</label>
                        <input
                          id="subNameInput"
                          type="text"
                          class="tg-input"
                          placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–¥–ø–∏—Å–∫–∏"
                        />
                      </div>

                      <p class="sidebar-hint subscription-hint">
                        –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –∏ –ª–∏—á–Ω—ã–µ —á–∞—Ç—ã –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –≤–∞—à –ª–∏—á–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç.
                      </p>

                      <div class="tg-field">
                        <label for="subChatInput">–ß–∞—Ç / –∫–∞–Ω–∞–ª</label>
                        <input
                          id="subChatInput"
                          type="text"
                          class="tg-input"
                          placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç/–∫–∞–Ω–∞–ª –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É"
                        />
                      </div>

                      <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ (–∫–∞–∫ –≤ "–ú–æ–∏ —á–∞—Ç—ã") -->
                      <div id="subChatsList" class="sidebar-chat-list sidebar-chat-list--compact" aria-label="–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏"></div>

                      <div class="tg-field">
                        <label for="subPeriodSelect">–ü–µ—Ä–∏–æ–¥ —á—Ç–µ–Ω–∏—è</label>
                        <select id="subPeriodSelect" class="tg-select">
                          <option value="10m">1 —Ä–∞–∑ –≤ 10 –º–∏–Ω—É—Ç</option>
                          <option value="30m">1 —Ä–∞–∑ –≤ 30 –º–∏–Ω—É—Ç</option>
                          <option value="1h" selected>1 —Ä–∞–∑ –≤ —á–∞—Å</option>
                          <option value="3h">1 —Ä–∞–∑ –≤ 3 —á–∞—Å–∞</option>
                          <option value="6h">1 —Ä–∞–∑ –≤ 6 —á–∞—Å–æ–≤</option>
                          <option value="1d">1 —Ä–∞–∑ –≤ –¥–µ–Ω—å</option>
                        </select>
                      </div>

                      <div class="tg-field">
                        <label for="subPromptInput">–¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞</label>
                        <textarea
                          id="subPromptInput"
                          class="tg-textarea"
                          rows="3"
                          placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏: –∫–∞–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å–æ–±–∏—Ä–∞—Ç—å –∏ –∫–æ–≥–¥–∞ —É–≤–µ–¥–æ–º–ª—è—Ç—å"
                        ></textarea>
                        <p class="tg-status">
                          –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–ª–∏ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–π –∑–∞–ø—Ä–æ—Å ‚Äî –∞–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è OpenAI.
                        </p>
                      </div>

                      <div class="subscription-actions">
                        <button id="createSubscriptionBtn" type="button" class="tg-button">
                          –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
                        </button>
                        <button id="cancelSubscriptionBtn" type="button" class="tg-button">
                          –û—Ç–º–µ–Ω–∞
                        </button>
                      </div>

                      <p id="subCreateStatus" class="tg-status"></p>
                    </div>

                    
                  </div>

                </details>
              </div>
                
            </div>

            <!-- Resizer -->
            <div id="sidebarResizer" class="sidebar-resizer" title="–ò–∑–º–µ–Ω–∏—Ç—å —à–∏—Ä–∏–Ω—É –ø–∞–Ω–µ–ª–∏"></div>

            </aside>

           <div class="dashboard-container">
              <div class="dashboard-top-block">

              <!-- –ü–æ–ª–æ—Å–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —á–∞—Ç–∞ -->
              <div id="chatTitleBar" class="chat-title-bar" style="display:none;">
                  <span id="chatTitleText"></span>
              </div>
              <div class="dashboard-results-viewer">
                
                <div class="dashboard-loader">
                  <div class="dashboard-loader-cat">
                    <div class="dashboard-cat-body">
                      <div
                        class="dashboard-cat-ear dashboard-cat-ear-left"
                      ></div>
                      <div
                        class="dashboard-cat-ear dashboard-cat-ear-right"
                      ></div>
                      <div class="dashboard-cat-face">
                        <div
                          class="dashboard-cat-eye dashboard-cat-eye-left"
                        ></div>
                        <div
                          class="dashboard-cat-eye dashboard-cat-eye-right"
                        ></div>
                        <div class="dashboard-cat-nose"></div>
                      </div>
                    </div>
                    <div class="dashboard-cat-tail"></div>
                  </div>
                  <p class="dashboard-loader-text section-content">
                    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ...
                  </p>
                </div>
                 <pre id="analysisResult" class="dashboard-results-text"></pre>
              </div>
            </div>
            <div class="dashboard-bottom-block">
              <div class="dashboard-input-panel">
                <div class="analysis-controls">
                  <!-- –ö–Ω–æ–ø–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ —á–∞—Ç–∞ -->
                  <button
                    id="uploadBtn"
                    class="analysis-icon-button"
                    type="button"
                    title="–ò–º–ø–æ—Ä—Ç —á–∞—Ç–∞"
                  >
                    <!-- reuse SVG –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ —Å—Ç–∞—Ä–æ–π —Ä–∞–∑–º–µ—Ç–∫–∏ -->
                    <svg
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M12 3v12m5-7l-5-5l-5 5m14 7v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </button>

                  <!-- –°–∫—Ä—ã—Ç—ã–π input —Ñ–∞–π–ª–∞ -->
                  <input type="file" id="chatFile" accept=".json" style="display:none" />
            
                  <!-- –û–≤–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ –∑–∞–ø—Ä–æ—Å–∞ -->
                  <input
                    id="queryInput"
                    type="text"
                    class="analysis-query-input"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞"
                  />
            
                  <!-- –ö–Ω–æ–ø–∫–∞ play -->
                  <button
                    id="analyzeBtn"
                    class="analysis-icon-button analysis-play-button"
                    type="button"
                    title="–í—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑"
                  >
                    <svg
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                  d="M8 5v14l11-7z"
                  fill="currentColor"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linejoin="round"
                />
                    </svg>
                  </button>
                </div>

                <!-- –ó–¥–µ—Å—å –º–∞–ª–µ–Ω—å–∫–∏–π –¥–∏—Å–∫–ª–µ–π–º–µ—Ä –ø–æ–¥ –ø–∞–Ω–µ–ª—å—é –≤–≤–æ–¥–∞ -->
                <p class="analysis-disclaimer">
                  ‚ö†Ô∏è –ê–Ω–∞–ª–∏–∑ —á–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å—Ç–æ—Ä–æ–Ω–Ω–µ–π –º–æ–¥–µ–ª—å—é –ò–ò (OpenAI).
                  –ù–µ –∑–∞–≥—Ä—É–∂–∞–π—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –∏–ª–∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
                </p>
              </div>
            </div>
          </div>
        </div>
          
        <style>
          @keyframes dashboardFloat { 0%,100% {transform: translateY(0) rotate(0deg);} 50% {transform: translateY(-20px) rotate(5deg);} }
          @keyframes dashboardBlink { 0%,48%,52%,100% {height: 8px;} 50% {height: 2px;} }
          @keyframes dashboardTailWag { 0%,100% {transform: rotate(-45deg);} 50% {transform: rotate(-25deg);} }
          @keyframes dashboardPulse { 0%,100% {opacity: 1;} 50% {opacity: 0.5;} }
        </style>
      
      <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

       <script defer data-name="dashboard-interactions">
  document.addEventListener("DOMContentLoaded", function () {
    (function () {
      const BACKEND_URL = "https://cotel-backend.onrender.com/analyze";
      const SUBS_API_BASE = "https://cotel-backend.onrender.com";

      const uploadBtn = document.getElementById("uploadBtn");
      const fileInput = document.getElementById("chatFile");
      const queryInput = document.getElementById("queryInput");
      const analyzeBtn = document.getElementById("analyzeBtn");
      const loader = document.querySelector(".dashboard-loader");
      const resultDiv = document.getElementById("analysisResult");

      // --- –≠–õ–ï–ú–ï–ù–¢–´ –î–õ–Ø –í–´–ë–û–†–ê –ò–°–¢–û–ß–ù–ò–ö–ê –î–ê–ù–ù–´–• ---
      const dataSourceFileRadio = document.getElementById("dataSourceFile");
      const dataSourceAccountRadio = document.getElementById("dataSourceAccount");
      const dataSourcePublicRadio = document.getElementById("dataSourcePublic");
      const dataSourceBotRadio = document.getElementById("dataSourceBot");

      const tgAuthBlock = document.getElementById("tgAuthBlock");
      const tgStatePhone = document.getElementById("tgStatePhone");
      const tgStateCode = document.getElementById("tgStateCode");
      const tgStateConnected = document.getElementById("tgStateConnected");
      const tgStatePassword = document.getElementById("tgStatePassword");
      const tgPasswordInput = document.getElementById("tgPasswordInput");
      const tgConfirmPasswordBtn = document.getElementById("tgConfirmPasswordBtn");

      const tgQrStartBtn = document.getElementById("tgQrStartBtn");
      const tgQrRestartBtn = document.getElementById("tgQrRestartBtn");
      const tgQrArea = document.getElementById("tgQrArea");
      const tgQrCanvas = document.getElementById("tgQrCanvas");
      const tgQrStatus = document.getElementById("tgQrStatus");

      let tgQrPollTimer = null;
      let tgQrObj = null; // instance of QRCode


      const tgPhoneInput = document.getElementById("tgPhoneInput");
      const tgSendCodeBtn = document.getElementById("tgSendCodeBtn");
      const tgCodeInput = document.getElementById("tgCodeInput");
      const tgConfirmCodeBtn = document.getElementById("tgConfirmCodeBtn");
      const tgCancelCodeBtn = document.getElementById("tgCancelCodeBtn");
      const tgStatusMessage = document.getElementById("tgStatusMessage");
      const tgConnectedUser = document.getElementById("tgConnectedUser");
      const tgLogoutBtn = document.getElementById("tgLogoutBtn");
      const tgLogoutBtnStatus = document.getElementById("tgLogoutBtnStatus");

      const telegramStatusSection = document.getElementById("telegramStatusSection");
      const tgStatusDot = document.getElementById("tgStatusDot");
      const tgStatusText = document.getElementById("tgStatusText");
      const tgStatusUsername = document.getElementById("tgStatusUsername");

      // –ø–æ–ª—è –¥–ª—è "–ú–æ–π –∞–∫–∫–∞—É–Ω—Ç Telegram"
      const activeChatInput = document.getElementById("activeChatInput");
      const queryDaysInput = document.getElementById("queryDaysInput");

      // --- –ü–æ–¥–ø–∏—Å–∫–∏ ---
      const addSubscriptionBtn = document.getElementById("addSubscriptionBtn");
      const subscriptionCreateBlock = document.getElementById("subscriptionCreateBlock");
      const subNameInput = document.getElementById("subNameInput");
      const subChatInput = document.getElementById("subChatInput");
      const subChatsList = document.getElementById("subChatsList");
      const subPeriodSelect = document.getElementById("subPeriodSelect");
      const subPromptInput = document.getElementById("subPromptInput");
      const createSubscriptionBtn = document.getElementById("createSubscriptionBtn");
      const cancelSubscriptionBtn = document.getElementById("cancelSubscriptionBtn");
      const subCreateStatus = document.getElementById("subCreateStatus");
      const subscriptionsList = document.getElementById("subscriptionsList");

      // Modal
      const botConnectModal = document.getElementById("botConnectModal");
      const modalOkBtn = document.getElementById("modalOkBtn");

      
      // —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–æ–π –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏
      const sidebar = document.querySelector(".dashboard-sidebar");
      const sidebarToggle = document.getElementById("sidebarToggle");
      const myChatsList = document.getElementById("myChatsList");
      const sidebarResizer = document.getElementById("sidebarResizer");

      let cachedChats = []; // [{id,title,type,username}]

      activeChatInput?.addEventListener("input", filterChatsByInput);

      // –ú–ê–°–ö–ê –î–õ–Ø –¢–ï–õ–ï–§–û–ù–ê +7
      if (tgPhoneInput) {
        tgPhoneInput.addEventListener("input", function () {
          let value = tgPhoneInput.value.replace(/\D/g, ""); // —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã

          // –ù–∞—á–∏–Ω–∞–µ–º –≤—Å–µ–≥–¥–∞ —Å "7"
          if (!value.startsWith("7")) {
            value = "7" + value;
          }

          // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –¥–æ 11 —Ü–∏—Ñ—Ä
          value = value.substring(0, 11);

          // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
          let formatted = "+7";

          if (value.length > 1) formatted += " " + value.substring(1, 4);
          if (value.length > 4) formatted += " " + value.substring(4, 7);
          if (value.length > 7) formatted += " " + value.substring(7, 9);
          if (value.length > 9) formatted += " " + value.substring(9, 11);

          tgPhoneInput.value = formatted;
        });

        // –ù–µ –¥–∞—ë–º —É–¥–∞–ª–∏—Ç—å "+7"
        tgPhoneInput.addEventListener("keydown", (e) => {
          if (
            tgPhoneInput.selectionStart < 2 &&
            (e.key === "Backspace" || e.key === "Delete")
          ) {
            e.preventDefault();
          }
        });
      }

      function updateDataSourceUI() {
        const checked = document.querySelector('input[name="dataSource"]:checked');
        const mode = checked ? checked.value : "file";

        // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º / —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
        if (uploadBtn) {
          uploadBtn.style.display = mode === "file" ? "inline-flex" : "none";
        }

        // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º / —Å–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram
        if (tgAuthBlock) {
          tgAuthBlock.style.display = mode === "account" ? "block" : "none";
        }

        if (telegramStatusSection && dataSourceAccountRadio) {
          telegramStatusSection.style.display =
            dataSourceAccountRadio.checked ? "block" : "none";
        }
      }

      function setTgState(state) {
        if (tgStatePhone) {
          tgStatePhone.style.display = state === "phone" ? "block" : "none";
        }
        if (tgStateCode) {
          tgStateCode.style.display = state === "code" ? "block" : "none";
        }
        if (tgStatePassword) {
          tgStatePassword.style.display = state === "password" ? "block" : "none";
        }
        if (tgStateConnected) {
          tgStateConnected.style.display = state === "connected" ? "block" : "none";
        }
      }

      function setTelegramConnectionStatus(isConnected, username = null) {
        const miniDot = document.getElementById("tgMiniStatusDot");
        const logoutBtn = document.getElementById("tgLogoutBtnStatus");

        if (miniDot) {
          miniDot.className =
            "tg-status-dot " + (isConnected ? "tg-status-on" : "tg-status-off");
        }

        if (!telegramStatusSection || !tgStatusDot || !tgStatusText || !tgStatusUsername) {
          return;
        }

        telegramStatusSection.style.display = "block";
        
        if (isConnected) {
          tgStatusDot.classList.remove("tg-status-off");
          tgStatusDot.classList.add("tg-status-on");
          tgStatusText.textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ";
          tgStatusUsername.textContent = username || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";

          logoutBtn.style.display = "block"; 

        } else {
          tgStatusDot.classList.remove("tg-status-on");
          tgStatusDot.classList.add("tg-status-off");
          tgStatusText.textContent = "–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ";
          tgStatusUsername.textContent = "‚Äî";

          logoutBtn.style.display = "none"; 
        }
      }

      function renderQr(url) {
        const box = document.getElementById("tgQrCanvas");
        if (!box) return;

        // —á–∏—Å—Ç–∏–º
        box.innerHTML = "";

        // –≤—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä: —à–∏—Ä–∏–Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –º–∏–Ω—É—Å –ø–∞–¥–¥–∏–Ω–≥–∏
        const available = box.clientWidth - 20; // 20 ‚Äî –µ—Å–ª–∏ padding 10+10
        const size = Math.max(160, Math.min(available, 220)); // –∫–æ—Ä–∏–¥–æ—Ä 160‚Äì220

        new QRCode(box, {
          text: url,
          width: size,
          height: size,
          correctLevel: QRCode.CorrectLevel.M
        });
      }


      function stopQrPolling() {
        if (tgQrPollTimer) {
          clearInterval(tgQrPollTimer);
          tgQrPollTimer = null;
        }
      }

      async function pollQrStatus() {
        try {
          const resp = await fetch("https://cotel-backend.onrender.com/tg/qr/status");
          const data = await resp.json();

          if (!resp.ok) {
            tgQrStatus.textContent = "–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞: " + (data.detail || resp.statusText);
            return;
          }

          if (data.status === "waiting") {
            tgQrStatus.textContent = "–û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ Telegram‚Ä¶";
            return;
          }

          if (data.status === "expired") {
            tgQrStatus.textContent = "QR-–∫–æ–¥ –∏—Å—Ç—ë–∫. –û–±–Ω–æ–≤–∏—Ç–µ QR.";
            tgQrRestartBtn.style.display = "inline-flex";
            stopQrPolling();
            return;
          }

          if (data.status === "password_needed") {
            tgQrStatus.textContent = "Telegram –∑–∞–ø—Ä–æ—Å–∏–ª 2FA-–ø–∞—Ä–æ–ª—å. –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –Ω–∏–∂–µ.";
            setTgState("password");
            if (tgQrArea) tgQrArea.style.display = "none";  // <-- –¥–æ–±–∞–≤–∏—Ç—å
            stopQrPolling();
            return;
          }

          if (data.status === "authorized") {
            tgQrStatus.textContent = "–£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ.";
            const username = data.username || data.first_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";

            tgConnectedUser.textContent = data.username ? ("@" + data.username) : username;
            setTgState("connected");
            setTelegramConnectionStatus(true, username);

            stopQrPolling();
            await loadTelegramChats();
            await refreshSubscriptions();
            return;
          }

          if (data.status === "no_qr") {
            tgQrStatus.textContent = "";
            stopQrPolling();
            return;
          }

          if (data.status === "error") {
            tgQrStatus.textContent = "–û—à–∏–±–∫–∞: " + (data.detail || "unknown");
            stopQrPolling();
            return;
          }
        } catch (e) {
          tgQrStatus.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ polling: " + e.message;
        }
      }

      async function startQrLogin() {
        tgStatusMessage.textContent = "";
        if (tgQrStatus) tgQrStatus.textContent = "–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR-–∫–æ–¥‚Ä¶";
        if (tgQrArea) tgQrArea.style.display = "block";
        if (tgQrRestartBtn) tgQrRestartBtn.style.display = "none";

        stopQrPolling();

        try {
          const resp = await fetch("https://cotel-backend.onrender.com/tg/qr/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({}),
          });

          const data = await resp.json();
          if (!resp.ok) {
            tgQrStatus.textContent = "–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞ QR: " + (data.detail || "unknown");
            return;
          }

          renderQr(data.url);
          tgQrStatus.textContent = "–û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ Telegram‚Ä¶";

          tgQrPollTimer = setInterval(pollQrStatus, 1500);
        } catch (e) {
          tgQrStatus.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + e.message;
        }
      }

      // –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      setTgState("phone");

      function showLoader(show) {
        if (!loader) return;
        loader.style.display = show ? "flex" : "none";
      }

      // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä—è—á–µ–º –∫–æ—Ç–∏–∫–∞
      showLoader(false);

      // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–±–Ω–æ–≤–ª—è–µ–º UI –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∏—Å—Ç–æ—á–Ω–∏–∫—É
      updateDataSourceUI();
      setTelegramConnectionStatus(false, null);

      // —Å–ª—É—à–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö
      dataSourceFileRadio?.addEventListener("change", updateDataSourceUI);
      dataSourceAccountRadio?.addEventListener("change", updateDataSourceUI);
      dataSourcePublicRadio?.addEventListener("change", updateDataSourceUI);
      dataSourceBotRadio?.addEventListener("change", updateDataSourceUI);


      tgQrStartBtn?.addEventListener("click", startQrLogin);
      tgQrRestartBtn?.addEventListener("click", startQrLogin);

      // --- –°–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ / —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ ---
      if (sidebar && sidebarToggle) {
        sidebarToggle.addEventListener("click", () => {
          const isCollapsed = sidebar.classList.toggle("collapsed");
          sidebarToggle.setAttribute(
            "title",
            isCollapsed ? "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø–∞–Ω–µ–ª—å" : "–°–≤–µ—Ä–Ω—É—Ç—å –ø–∞–Ω–µ–ª—å"
          );
          // üëá –í–ê–ñ–ù–û: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è CSS (–ª–æ–≥–æ—Ç–∏–ø, –æ—Ç—Å—Ç—É–ø—ã –∏ —Ç.–¥.)
          document.body.classList.toggle("sidebar-collapsed", isCollapsed);
         
        });
      }

      // --- –ú–∏–Ω–∏-–∏–∫–æ–Ω–∫–∏ –≤ —Å–≤–µ—Ä–Ω—É—Ç–æ–π –ø–∞–Ω–µ–ª–∏ ---
      const miniIconButtons = document.querySelectorAll(".sidebar-mini-icon-btn");
      miniIconButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const targetId = btn.getAttribute("data-target");

          // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
          if (sidebar) {
            sidebar.classList.remove("collapsed");
          }
          if (sidebarToggle) {
            sidebarToggle.setAttribute("title", "–°–≤–µ—Ä–Ω—É—Ç—å –ø–∞–Ω–µ–ª—å");
          }

          // –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π –±–ª–æ–∫ <details>
          if (targetId) {
            const detailsEl = document.getElementById(targetId);
            if (detailsEl && detailsEl.tagName.toLowerCase() === "details") {
              detailsEl.open = true;
              detailsEl.scrollIntoView({
                behavior: "smooth",
                block: "nearest",
              });
            }
          }
        });
      });

      // --- Resizable sidebar (drag to resize) ---
      (function initSidebarResize() {
        if (!sidebar || !sidebarResizer) return;

        const MIN_W = 280;
        const MAX_W = 520;

        // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —à–∏—Ä–∏–Ω—É –∏–∑ localStorage
        const saved = localStorage.getItem("cotel_sidebar_width");
        if (saved) {
          const w = Math.max(MIN_W, Math.min(MAX_W, parseInt(saved, 10)));
          document.documentElement.style.setProperty("--sidebar-width", `${w}px`);
        }

        let isDragging = false;

        function onMouseMove(e) {
          if (!isDragging) return;

          // –µ—Å–ª–∏ –ø–∞–Ω–µ–ª—å —Å–≤–µ—Ä–Ω—É—Ç–∞ ‚Äî –Ω–µ –¥–∞—ë–º —Ä–µ—Å–∞–π–∑–∏—Ç—å
          if (sidebar.classList.contains("collapsed")) return;

          const rect = sidebar.getBoundingClientRect();
          const newW = Math.max(MIN_W, Math.min(MAX_W, e.clientX - rect.left));

          document.documentElement.style.setProperty("--sidebar-width", `${newW}px`);
          localStorage.setItem("cotel_sidebar_width", String(newW));
        }

        function stopDrag() {
          isDragging = false;
          document.body.style.cursor = "";
          document.body.style.userSelect = "";
          window.removeEventListener("mousemove", onMouseMove);
          window.removeEventListener("mouseup", stopDrag);
        }

        sidebarResizer.addEventListener("mousedown", (e) => {
          // –µ—Å–ª–∏ –ø–∞–Ω–µ–ª—å —Å–≤–µ—Ä–Ω—É—Ç–∞ ‚Äî —Å–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å (–ø–æ UX –ø—Ä–æ—â–µ)
          if (sidebar.classList.contains("collapsed")) {
            sidebar.classList.remove("collapsed");
            document.body.classList.remove("sidebar-collapsed");
            if (sidebarToggle) sidebarToggle.setAttribute("title", "–°–≤–µ—Ä–Ω—É—Ç—å –ø–∞–Ω–µ–ª—å");
          }

          isDragging = true;
          document.body.style.cursor = "col-resize";
          document.body.style.userSelect = "none";
          window.addEventListener("mousemove", onMouseMove);
          window.addEventListener("mouseup", stopDrag);
          e.preventDefault();
        });
      })();

      // --- –ü–û–í–ï–î–ï–ù–ò–ï –ë–õ–û–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò TELEGRAM ---
      tgSendCodeBtn?.addEventListener("click", async () => {
        const phone = (tgPhoneInput?.value || "").trim();
        if (!phone) {
          tgStatusMessage.textContent = "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.";
          return;
        }

        tgStatusMessage.textContent = "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥...";

        try {
          const resp = await fetch(
            "https://cotel-backend.onrender.com/tg/send_code",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ phone }),
            }
          );

          const data = await resp.json();

          if (!resp.ok) {
            tgStatusMessage.textContent =
              "–û—à–∏–±–∫–∞: " + (data.detail || "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥.");
            return;
          }

          tgStatusMessage.textContent =
            "–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram.";
          setTgState("code");
        } catch (err) {
          tgStatusMessage.textContent =
            "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + err.message;
        }
      });

      tgConfirmCodeBtn?.addEventListener("click", async () => {
        const phone = (tgPhoneInput?.value || "").trim();
        const code = (tgCodeInput?.value || "").trim();

        if (!code) {
          tgStatusMessage.textContent = "–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ Telegram.";
          return;
        }

        tgStatusMessage.textContent = "–ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥...";

        try {
          const resp = await fetch(
            "https://cotel-backend.onrender.com/tg/confirm_code",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ phone, code }),
            }
          );

          const data = await resp.json();
          const detail = String(data.detail || "");

          if (!resp.ok) {
            if (
              detail.includes("SESSION_PASSWORD_NEEDED") ||
              detail.includes("PASSWORD_NEEDED")
            ) {
              tgStatusMessage.textContent =
                "–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å Telegram (2FA).";
              setTgState("password");
              return;
            }

            tgStatusMessage.textContent =
              "–û—à–∏–±–∫–∞: " + (data.detail || "–ö–æ–¥ –Ω–µ–≤–µ—Ä–µ–Ω.");
            return;
          }

          // —É—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
          tgConnectedUser.textContent = data.username
            ? "@" + data.username
            : data.first_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";

          tgStatusMessage.textContent = "–£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ.";

          setTgState("connected");
          setTelegramConnectionStatus(true, data.username || data.first_name);
          await loadTelegramChats();
          await refreshSubscriptions();
        } catch (err) {
          tgStatusMessage.textContent =
            "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + err.message;
        }
      });

      tgConfirmPasswordBtn?.addEventListener("click", async () => {
        const phone = (tgPhoneInput?.value || "").trim();
        const password = (tgPasswordInput?.value || "").trim();

        if (!password) {
          tgStatusMessage.textContent = "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å Telegram.";
          return;
        }

        tgStatusMessage.textContent = "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –ø–∞—Ä–æ–ª—å...";

        try {
          const resp = await fetch(
            "https://cotel-backend.onrender.com/tg/confirm_password",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ phone, password }),
            }
          );

          const data = await resp.json();

          if (!resp.ok) {
            tgStatusMessage.textContent =
              "–û—à–∏–±–∫–∞: " + (data.detail || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–∞—Ä–æ–ª—å.");
            return;
          }

          tgConnectedUser.textContent = data.username
            ? "@" + data.username
            : data.first_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";

          tgStatusMessage.textContent = "–£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ.";
          setTgState("connected");
          setTelegramConnectionStatus(true, data.username || data.first_name);
          await loadTelegramChats();
          await refreshSubscriptions();
        } catch (err) {
          tgStatusMessage.textContent =
            "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + err.message;
        }
      });

      tgCancelCodeBtn?.addEventListener("click", () => {
        if (tgPhoneInput) tgPhoneInput.value = "";
        if (tgCodeInput) tgCodeInput.value = "";
        if (tgStatusMessage) tgStatusMessage.textContent = "";
        setTgState("phone");
        setTelegramConnectionStatus(false, null);
      });

      [tgLogoutBtn, tgLogoutBtnStatus].forEach((btn) => {
        btn?.addEventListener("click", async () => {
          tgStatusMessage.textContent = "–ó–∞–≤–µ—Ä—à–∞–µ–º —Å–µ—Å—Å–∏—é...";

          try {
            const resp = await fetch("https://cotel-backend.onrender.com/tg/logout", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
            });

            const data = await resp.json();

            if (!resp.ok) {
              tgStatusMessage.textContent =
                "–û—à–∏–±–∫–∞: " + (data.detail || "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é.");
              return;
            }

            tgConnectedUser.textContent = "@username";
            setTgState("phone");
            setTelegramConnectionStatus(false, null);

            // –≤–∞–∂–Ω–æ: —É —Ç–µ–±—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è myChatsList
            if (myChatsList) myChatsList.innerHTML = "";

            tgStatusMessage.textContent = "–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.";
          } catch (err) {
            tgStatusMessage.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + err.message;
          }
        });
      });


      // –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ —Å –∏–∫–æ–Ω–∫–æ–π ‚Üí –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞
      if (uploadBtn && fileInput) {
        uploadBtn.addEventListener("click", () => {
          fileInput.value = "";
          fileInput.click();
        });

        fileInput.addEventListener("change", () => {
          if (!fileInput.files[0]) return;
          if (resultDiv) {
            resultDiv.textContent = `–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${fileInput.files[0].name}`;
          }
        });
      }


      async function loadTelegramChats() {
        try {
          const resp = await fetch("https://cotel-backend.onrender.com/tg/chats", {
            method: "GET",
            credentials: "omit",
          });
      
          const rawText = await resp.text();
          let data = null;
          try { data = rawText ? JSON.parse(rawText) : null; } catch {}
      
          if (!resp.ok) {
            // –µ—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
            return;
          }
      
          cachedChats = (data && data.chats) ? data.chats : [];
          renderChatsList(cachedChats);
          renderSubChatsList(cachedChats);

        } catch (e) {
          // –º–æ–ª—á–∞: —Å–ø–∏—Å–æ–∫ ‚Äî –¥–æ–ø. —É–¥–æ–±—Å—Ç–≤–æ, –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
        }
      }

      function renderChatsList(list) {
        if (!myChatsList) return;
      
        if (!list || list.length === 0) {
          myChatsList.innerHTML = `<div class="sidebar-chat-empty">–ß–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>`;
          return;
        }
      
        myChatsList.innerHTML = list
          .map((c) => {
            // ‚Äú–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä‚Äù, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ–º –ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å –≤ activeChatInput:
            // –µ—Å–ª–∏ –µ—Å—Ç—å username -> @username, –∏–Ω–∞—á–µ -> numeric id
            const linkValue = c.username ? `@${c.username}` : String(c.id || "");
            const safeTitle = (c.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            return `<div class="sidebar-chat-item" data-link="${linkValue}" title="${safeTitle}">${safeTitle}</div>`;
          })
          .join("");
      
        // –∫–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ
        myChatsList.querySelectorAll(".sidebar-chat-item").forEach((el) => {
          el.addEventListener("click", () => {
            const link = el.getAttribute("data-link") || "";
            if (activeChatInput) activeChatInput.value = link;
          });
        });
      }
      
      function renderSubChatsList(list) {
        if (!subChatsList) return;

        if (!list || list.length === 0) {
          subChatsList.innerHTML = `<div class="sidebar-chat-empty">–ß–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>`;
          return;
        }

        subChatsList.innerHTML = list
          .map((c) => {
            const linkValue = c.username ? `@${c.username}` : String(c.id || "");
            const safeTitle = (c.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            return `<div class="sidebar-chat-item" data-link="${linkValue}" title="${safeTitle}">${safeTitle}</div>`;
          })
          .join("");

        subChatsList.querySelectorAll(".sidebar-chat-item").forEach((el) => {
          el.addEventListener("click", () => {
            const link = el.getAttribute("data-link") || "";
            if (subChatInput) subChatInput.value = link;
          });
        });
      }


      function filterChatsByInput() {
        const q = (activeChatInput?.value || "").trim().toLowerCase();
        if (!q) {
          renderChatsList(cachedChats);
          return;
        }
      
        // —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ title (–∏ –ø–æ username —Ç–æ–∂–µ, —á—Ç–æ–±—ã —É–¥–æ–±–Ω–æ)
        const filtered = cachedChats.filter((c) => {
          const t = (c.title || "").toLowerCase();
          const u = (c.username || "").toLowerCase();
          return t.includes(q) || u.includes(q.replace("@", ""));
        });
      
        renderChatsList(filtered);
      }

      function openModal() {
        if (botConnectModal) botConnectModal.style.display = "flex";
      }

      function closeModal() {
        if (botConnectModal) botConnectModal.style.display = "none";
      }

      modalOkBtn?.addEventListener("click", closeModal);
      botConnectModal?.addEventListener("click", (e) => {
        if (e.target === botConnectModal) closeModal();
      });

      subChatInput?.addEventListener("input", () => {
        const q = (subChatInput.value || "").trim().toLowerCase();
        if (!q) {
          renderSubChatsList(cachedChats);
          return;
        }
        const filtered = cachedChats.filter((c) => {
          const t = (c.title || "").toLowerCase();
          const u = (c.username || "").toLowerCase();
          return t.includes(q) || u.includes(q.replace("@", ""));
        });
        renderSubChatsList(filtered);
      });

      function periodToMinutes(v) {
        // UI values in <select>: 10m/30m/1h/3h/6h/1d
        const map = {
          "10m": 10,
          "30m": 30,
          "1h": 60,
          "3h": 180,
          "6h": 360,
          "1d": 1440
        };
        return map[v] ?? 60;
      }

        function minutesToHuman(m) {
          const n = Number(m);
          if (n === 10) return "1 —Ä–∞–∑ –≤ 10 –º–∏–Ω—É—Ç";
          if (n === 30) return "1 —Ä–∞–∑ –≤ 30 –º–∏–Ω—É—Ç";
          if (n === 60) return "1 —Ä–∞–∑ –≤ —á–∞—Å";
          if (n === 180) return "1 —Ä–∞–∑ –≤ 3 —á–∞—Å–∞";
          if (n === 360) return "1 —Ä–∞–∑ –≤ 6 —á–∞—Å–æ–≤";
          if (n === 1440) return "1 —Ä–∞–∑ –≤ –¥–µ–Ω—å";
          return `${n} –º–∏–Ω`;
        }

        async function apiGetSubscriptions() {
          const resp = await fetch(`${SUBS_API_BASE}/subscriptions`, {
                  method: "GET",
          headers: { "Accept": "application/json" }
        });

        const raw = await resp.text();
        let data = null;
        try { data = raw ? JSON.parse(raw) : null; } catch {}

        if (!resp.ok) {
          const msg = (data && (data.detail || data.error)) || raw || resp.statusText;
          throw new Error(msg);
        }

        // –æ–∂–∏–¥–∞–µ–º –º–∞—Å—Å–∏–≤
        return Array.isArray(data) ? data : [];
      }

      async function apiCreateSubscription(payload) {
        const resp = await fetch(`${SUBS_API_BASE}/subscriptions`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Accept": "application/json" },
          body: JSON.stringify(payload)
        });

        const raw = await resp.text();
        let data = null;
        try { data = raw ? JSON.parse(raw) : null; } catch {}

        if (!resp.ok) {
          const msg = (data && (data.detail || data.error)) || raw || resp.statusText;
          throw new Error(msg);
        }

        return data;
      }



      function renderSubscriptions(list) {
        if (!subscriptionsList) return;

        const subs = Array.isArray(list) ? list : [];

        if (!subs.length) {
          subscriptionsList.innerHTML = "";
          return;
        }

        subscriptionsList.innerHTML = subs.map((s) => {
          const safeName = String(s.name || "–ü–æ–¥–ø–∏—Å–∫–∞")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");

          // status: active/paused/error (–ø–æ–∫–∞ –±—ç–∫ –º–æ–∂–µ—Ç –æ—Ç–¥–∞–≤–∞—Ç—å active; –æ—Å—Ç–∞–ª—å–Ω–æ–µ –Ω–∞ –±—É–¥—É—â–µ–µ)
          const status = String(s.status || (s.is_active ? "active" : "paused")).toLowerCase();

          let dotClass = "subscription-status-dot";
          if (status === "paused") dotClass += " is-paused";
          if (status === "error") dotClass += " is-error";

          const freqText = minutesToHuman(s.frequency_minutes);

          return `
            <div class="subscription-item" data-sub-id="${s.id || ""}" title="${safeName}">
              <span class="${dotClass}"></span>
              <span class="subscription-name">${safeName}</span>

              <div class="subscription-actions-mini" aria-label="–î–µ–π—Å—Ç–≤–∏—è –ø–æ–¥–ø–∏—Å–∫–∏">
                <button class="subscription-action-btn sub-btn-pause" type="button" title="–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å">‚è∏</button>
                <button class="subscription-action-btn sub-btn-play"  type="button" title="–í–∫–ª—é—á–∏—Ç—å">‚ñ∂</button>
                <button class="subscription-action-btn sub-btn-del"   type="button" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
              </div>
            </div>
          `;
        }).join("");

        // –ó–∞–≥–ª—É—à–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π (–ø–æ–∫–∞ –±–µ–∑ API)
        subscriptionsList.querySelectorAll(".sub-btn-pause").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.preventDefault(); e.stopPropagation();
            alert("MVP: –ø–æ–∑–∂–µ –¥–æ–±–∞–≤–∏–º API –ø–∞—É–∑—ã –ø–æ–¥–ø–∏—Å–∫–∏.");
          });
        });

        subscriptionsList.querySelectorAll(".sub-btn-play").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.preventDefault(); e.stopPropagation();
            alert("MVP: –ø–æ–∑–∂–µ –¥–æ–±–∞–≤–∏–º API –≤–∫–ª—é—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏.");
          });
        });

        subscriptionsList.querySelectorAll(".sub-btn-del").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.preventDefault(); e.stopPropagation();
            alert("MVP: –ø–æ–∑–∂–µ –¥–æ–±–∞–≤–∏–º API —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏.");
          });
        });
      }

      async function refreshSubscriptions() {
        try {
          const subs = await apiGetSubscriptions();
          renderSubscriptions(subs);
        } catch (e) {
          // –ù–∞ MVP –Ω–µ —Å–ø–∞–º–∏–º –æ—à–∏–±–∫–∞–º–∏, –Ω–æ –º–æ–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª—å
          console.warn("Subscriptions load failed:", e.message);
        }
      }


      function showSubscriptionForm(show) {
        if (!subscriptionCreateBlock) return;
        subscriptionCreateBlock.style.display = show ? "block" : "none";
        if (subCreateStatus) subCreateStatus.textContent = "";
      }

      function resetSubscriptionForm() {
        if (subNameInput) subNameInput.value = "";
        if (subChatInput) subChatInput.value = "";
        if (subPeriodSelect) subPeriodSelect.value = "1h";
        if (subPromptInput) {
          subPromptInput.value = "";
          autoResizeTextarea(subPromptInput);
        }
      }

      function autoResizeTextarea(el) {
        if (!el) return;
        el.style.height = "auto";
        el.style.height = Math.min(el.scrollHeight, 420) + "px";
      }

      subPromptInput?.addEventListener("input", () => autoResizeTextarea(subPromptInput));
      
      addSubscriptionBtn?.addEventListener("click", () => {
        // –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
        showSubscriptionForm(true);
        resetSubscriptionForm();

        // –Ω–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ (–µ—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã)
        renderSubChatsList(cachedChats);

        // –≤–∞–∂–Ω–æ: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, —Å–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –ø—É—Å—Ç ‚Äî –æ–∫
      });

      cancelSubscriptionBtn?.addEventListener("click", () => {
        showSubscriptionForm(false);
        resetSubscriptionForm();
      });

      createSubscriptionBtn?.addEventListener("click", async () => {
        if (!subCreateStatus) return;

        const name = (subNameInput?.value || "").trim();
        const chat_ref = (subChatInput?.value || "").trim();
        const periodVal = (subPeriodSelect?.value || "1h").trim();
        const prompt = (subPromptInput?.value || "").trim();

        if (!name) { subCreateStatus.textContent = "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–¥–ø–∏—Å–∫–∏."; return; }
        if (!chat_ref) { subCreateStatus.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç/–∫–∞–Ω–∞–ª –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É."; return; }
        if (!prompt) { subCreateStatus.textContent = "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏."; return; }

        const frequency_minutes = periodToMinutes(periodVal);

        subCreateStatus.textContent = "–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏‚Ä¶";
        openModal(); // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–≤–æ—ë —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ (–ø–æ–∫–∞ –±–µ–∑ –ª–æ–≥–∏–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)

        const payload = {
          name,
          source_mode: "personal",
          chat_ref,
          frequency_minutes,
          prompt,
          is_active: true
        };

        try {
          await apiCreateSubscription(payload);

          subCreateStatus.textContent = "–ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞.";
          showSubscriptionForm(false);

          // –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
          await refreshSubscriptions();
        } catch (e) {
          const msg = String(e.message || "");
          if (msg.includes("422")) {
            subCreateStatus.textContent = "–ü—Ä–æ–≤–µ—Ä—å –ø–æ–ª—è —Ñ–æ—Ä–º—ã (–æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏).";
          } else {
            subCreateStatus.textContent = "–û—à–∏–±–∫–∞: " + msg;
          }
        }
      });


      function renderResult(payload, rawText) {
        let text = "";

        if (payload?.summary) {
          text += payload.summary + "\n\n";
        }

        if (payload?.message) {
          text += payload.message;
        }

        if (resultDiv) {
          resultDiv.textContent = text || rawText || "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
        }

        if (payload?.chat_name) {
          const bar = document.getElementById("chatTitleBar");
          const title = document.getElementById("chatTitleText");
          if (bar && title) {
            title.textContent = payload.chat_name;
            bar.style.display = "block";
          }
        }
      }

      // –∫–Ω–æ–ø–∫–∞ Play
      if (analyzeBtn) {
        analyzeBtn.addEventListener("click", async () => {
          const query = (queryInput?.value || "").trim();
          const isTelegramJson = dataSourceFileRadio?.checked;
          const isTelegramAccount = dataSourceAccountRadio?.checked;

          showLoader(true);
          if (resultDiv) resultDiv.textContent = "";

          try {
            // 1Ô∏è‚É£ –í–ï–¢–ö–ê: TELEGRAM JSON
            if (isTelegramJson) {
              const file = fileInput?.files[0];

              if (!file) {
                alert("–°–Ω–∞—á–∞–ª–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ JSON-—Ñ–∞–π–ª —ç–∫—Å–ø–æ—Ä—Ç–∞ Telegram.");
                showLoader(false);
                return;
              }

              const formData = new FormData();
              formData.append("file", file);

              const params = {
                query: query || null,
                result_type: "summary",
              };
              formData.append("params", JSON.stringify(params));

              const resp = await fetch(BACKEND_URL, {
                method: "POST",
                body: formData,
              });

              const rawText = await resp.text();
              let data = null;

              try {
                data = rawText ? JSON.parse(rawText) : null;
              } catch {}

              if (!resp.ok) {
                throw new Error(
                  (data && (data.detail || data.error)) ||
                    rawText ||
                    resp.statusText
                );
              }

              renderResult(data, rawText);
              return;
            }

            // 2Ô∏è‚É£ –í–ï–¢–ö–ê: –ú–û–ô TELEGRAM –ê–ö–ö–ê–£–ù–¢
            if (isTelegramAccount) {
              const chatLink = (activeChatInput?.value || "").trim();
              const days = parseInt(queryDaysInput?.value || "7", 10);

              if (!chatLink) {
                alert("–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —á–∞—Ç –∏–ª–∏ –∫–∞–Ω–∞–ª Telegram.");
                showLoader(false);
                return;
              }

              const payload = {
                chat_link: chatLink,
                days: days,
                user_query: query || null,
              };

              const resp = await fetch(
                "https://cotel-backend.onrender.com/tg/analyze_chat",
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(payload),
                }
              );

              const rawText = await resp.text();
              let data = null;

              try {
                data = rawText ? JSON.parse(rawText) : null;
              } catch {}

              if (!resp.ok) {
                throw new Error(
                  (data && (data.detail || data.error)) ||
                    rawText ||
                    resp.statusText
                );
              }

              renderResult(data, rawText);
              return;
            }

            // 3Ô∏è‚É£ –ù–ò–ß–ï–ì–û –ù–ï –í–´–ë–†–ê–ù–û
            alert("–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö.");
          } catch (err) {
            if (resultDiv) {
              resultDiv.textContent = "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: " + err.message;
            }
          } finally {
            showLoader(false);
          }
        });
      }
    })();
  });
</script>



      <link
        rel="canonical"
        href="https://single-sane-falcon-xjmc7x.teleporthq.app/new-analysis"
      />
    </div>

    <!-- Modal: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–æ—Ç–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫ -->
  <div id="botConnectModal" class="modal-overlay" style="display:none;">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle" class="modal-title">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–æ—Ç–∞</h3>
      <p class="modal-text">
        –î–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å –±–æ—Ç–∞ –∫ CoTel.
      </p>

      <a class="modal-link" href="https://t.me/CoTel_AlertBot" target="_blank" rel="noopener">
        t.me/CoTel_AlertBot
      </a>

      <div class="modal-actions">
        <button id="modalOkBtn" type="button" class="tg-button">–ü–æ–Ω—è—Ç–Ω–æ</button>
      </div>
    </div>
  </div>


  </body>
</html>
